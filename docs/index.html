<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="./public/logo.ico" />
    <link rel="icon" type="image/png" href="./public/logo.png" />
    <link rel="apple-touch-icon" href="./public/logo.png" />
    <link rel="stylesheet" href="./style.css">
    <title>GradientGL - Procedural Gradient Animations</title>
    <base href="/gradient-gl/">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
        content="Tiny WebGL library for procedural gradient animations. Deterministic. Seed-driven." />
    <meta name="author" content="metaory" />
    <meta property="og:title" content="GradientGL - Procedural Gradient Animations" />
    <meta property="og:description"
        content="Tiny WebGL library for procedural gradient animations. Deterministic. Seed-driven." />
    <meta property="og:image" content="https://metaory.github.io/gradient-gl/public/social.jpg" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://metaory.github.io/gradient-gl/" />
    <meta property="og:author" content="metaory" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:site_name" content="GradientGL" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="GradientGL" />
    <meta name="twitter:description"
        content="Tiny WebGL library for procedural gradient animations. Deterministic. Seed-driven." />
    <meta name="twitter:image" content="https://metaory.github.io/gradient-gl/public/social.jpg" />
    <meta name="twitter:creator" content="@metaory" />
</head>

<body>
    <div class="loader"> </div>
    <span id="seed"></span>
    <a id="github" href="https://github.com/metaory/gradient-gl" target="_blank" rel="noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24">
            <path fill="currentColor" fill-opacity="0"
                d="M15 4.5c-0.39 -0.1 -1.33 -0.5 -3 -0.5c-1.67 0 -2.61 0.4 -3 0.5c-0.53 -0.43 -1.94 -1.5 -3.5 -1.5c-0.34 1 -0.29 2.22 0 3c-0.75 1 -1 2 -1 3.5c0 2.19 0.48 3.58 1.5 4.5c1.02 0.92 2.11 1.37 3.5 1.5c-0.65 0.54 -0.5 1.87 -0.5 2.5v4h6v-4c0 -0.63 0.15 -1.96 -0.5 -2.5c1.39 -0.13 2.48 -0.58 3.5 -1.5c1.02 -0.92 1.5 -2.31 1.5 -4.5c0 -1.5 -0.25 -2.5 -1 -3.5c0.29 -0.78 0.34 -2 0 -3c-1.56 0 -2.97 1.07 -3.5 1.5Z">
                <animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.15s" values="0;0.3" />
            </path>
            <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                <path stroke-dasharray="32" stroke-dashoffset="32"
                    d="M12 4c1.67 0 2.61 0.4 3 0.5c0.53 -0.43 1.94 -1.5 3.5 -1.5c0.34 1 0.29 2.22 0 3c0.75 1 1 2 1 3.5c0 2.19 -0.48 3.58 -1.5 4.5c-1.02 0.92 -2.11 1.37 -3.5 1.5c0.65 0.54 0.5 1.87 0.5 2.5c0 0.73 0 3 0 3M12 4c-1.67 0 -2.61 0.4 -3 0.5c-0.53 -0.43 -1.94 -1.5 -3.5 -1.5c-0.34 1 -0.29 2.22 0 3c-0.75 1 -1 2 -1 3.5c0 2.19 0.48 3.58 1.5 4.5c1.02 0.92 2.11 1.37 3.5 1.5c-0.65 0.54 -0.5 1.87 -0.5 2.5c0 0.73 0 3 0 3">
                    <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.7s" values="32;0" />
                </path>
                <path stroke-dasharray="10" stroke-dashoffset="10"
                    d="M9 19c-1.41 0 -2.84 -0.56 -3.69 -1.19c-0.84 -0.63 -1.09 -1.66 -2.31 -2.31">
                    <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.8s" dur="0.2s" values="10;0" />
                </path>
            </g>
        </svg>
    </a>
    <main>
        <div id="shaders"></div>
        <div id="options"></div>
        <div class="usage"></div>
    </main>
    <div class="toast">
        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24">
            <path fill="springgreen" fill-rule="evenodd"
                d="M12 22c-4.714 0-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12s0-7.071 1.464-8.536C4.93 2 7.286 2 12 2s7.071 0 8.535 1.464C22 4.93 22 7.286 22 12s0 7.071-1.465 8.535C19.072 22 16.714 22 12 22m4.03-13.03a.75.75 0 0 1 0 1.06l-5 5a.75.75 0 0 1-1.06 0l-2-2a.75.75 0 1 1 1.06-1.06l1.47 1.47l4.47-4.47a.75.75 0 0 1 1.06 0"
                clip-rule="evenodd" />
        </svg>
        URL copied to clipboard
    </div>
    <script type="module">
        import gradient from './index.js'
        gradient('a2.a8aa')

        /* context lost test
        let ext
        setTimeout(() => {
            ext = document.querySelector('canvas').getContext('webgl2').getExtension('WEBGL_lose_context')
            console.log('::', ext)
        }, 1_000)
        setTimeout(() => {
            console.log('LETS GET LOST')
            ext.loseContext()
        }, 3_000)
        setTimeout(() => {
            console.log('LETS GET FOUND')
            ext.restoreContext()
        }, 6_000)
        */
        import shaders, { shaders as shaderMap } from './shaders/index.js'

        // DOM Helpers
        const $ = document.querySelector.bind(document)
        const $$ = document.querySelectorAll.bind(document)
        const $id = document.getElementById.bind(document)
        const mkEl = (tag, props = {}, children = []) => {
            const el = document.createElement(tag)
            Object.entries(props).forEach(([k, v]) => {
                if (k === 'dataset') Object.entries(v).forEach(([dk, dv]) => el.dataset[dk] = dv)
                else el[k] = v
            })
            children.forEach(child => el.append(child))
            return el
        }

        const debounce = (fn, delay = 100) => {
            let timeout
            return (...args) => {
                clearTimeout(timeout)
                timeout = setTimeout(() => fn(...args), delay)
            }
        }

        const copyToClipboard = async (text) => {
            const result = await navigator.clipboard.writeText(text).then(() => true).catch(() => false)
            if (!result) console.error('Failed to copy to clipboard')
            return result
        }

        const showToast = (message) => {
            const toast = $('.toast')
            toast.textContent = message
            toast.classList.add('show')
            setTimeout(() => toast.classList.remove('show'), 1_000)
        }

        const loader = $('.loader')
        const toggleLoader = (show) => {
            loader.classList.toggle('show', show)
            document.body.style.pointerEvents = show ? 'none' : ''
        }

        const withLoader = fn => async (...args) => {
            toggleLoader(true)
            const result = await fn(...args)
            toggleLoader(false)
            return result
        }

        const createState = (initial) => {
            let state = initial
            const listeners = new Set()

            const update = (newState) => {
                state = { ...state, ...newState }
                listeners.forEach(fn => fn(state))
                return state
            }

            const subscribe = (fn) => {
                listeners.add(fn)
                return () => listeners.delete(fn)
            }

            return { get: () => state, update, subscribe }
        }

        const state = createState({
            seed: '',
            isVisible: true
        })

        const updateState = debounce(async () => {
            const shader = $('.shader[data-selected="true"]')?.dataset.shader
            if (!shader) return

            const getHexValue = id => parseInt($id(id).value, 10).toString(16).toLowerCase()
            const newSeed = `${shader}.${['speed', 'hue', 'saturation', 'lightness'].map(getHexValue).join('')}`

            if (newSeed === state.get().seed) return

            state.update({ seed: newSeed })
            $id('seed').textContent = newSeed

            await withLoader(gradient)(newSeed)
            updateUsage()

            const hash = window.location.hash
            if (hash && !hash.includes(newSeed)) {
                window.location.hash = ''
            }
        }, 50)

        const updateUsage = async () => {
            const usage = $('.usage')
            const { codeToHtml } = await import('https://esm.sh/shiki@3.0.0')
            const html = await codeToHtml(`import gradientGL from "gradient-gl"\n\ngradientGL("${state.get().seed}")`, {
                lang: 'javascript',
                theme: 'vitesse-dark',
                transformers: [{ pre: node => (delete node.properties.style, node) }]
            })
            usage.innerHTML = html
        }

        const loadSeedFromUrl = () => {
            const hash = window.location.hash.slice(1)
            if (!hash) return false

            const [shader, values] = hash.split('.')
            const isValidSeed = shader && values?.length === 4
            if (!isValidSeed) return false

            const shaderBtn = $(`.shader[data-shader="${shader}"]`)
            if (!shaderBtn) return false

            // Update shader selection
            $$('.shader').forEach(opt => {
                opt.dataset.selected = opt === shaderBtn ? 'true' : 'false'
            })

            // Update input values
            const ids = ['speed', 'hue', 'saturation', 'lightness']
            values.split('').forEach((value, i) => {
                const input = $id(ids[i])
                if (!input) return
                const intValue = parseInt(value, 16)
                input.value = intValue
                input.dataset.hexValue = value
            })

            return true
        }

        // UI Components
        const createRangeInput = ({ id, label }) => mkEl('input', {
            type: 'range',
            id,
            title: label,
            min: 0,
            max: 15,
            value: 7,
            dataset: { hexValue: '7' },
            oninput: e => {
                const hexValue = parseInt(e.target.value, 10).toString(16).toLowerCase()
                e.target.dataset.hexValue = hexValue
                updateState()
            }
        })

        const createShaderOption = shader => mkEl('button', {
            className: 'shader',
            textContent: shader,
            dataset: { shader },
            onclick: e => {
                const target = e.target
                $$('.shader').forEach(opt => {
                    opt.dataset.selected = opt === target ? 'true' : 'false'
                })
                updateState()
            }
        })

        const randomizeOptions = async () => {
            // Randomize shader
            const randomShader = shaders[Math.floor(Math.random() * 6)]
            $$('.shader').forEach(btn => {
                btn.dataset.selected = btn.dataset.shader === randomShader ? 'true' : 'false'
            })

            // Randomize inputs
            const inputs = ['speed', 'hue', 'saturation', 'lightness'].map(id => $id(id))
            inputs.forEach((input, index) => {
                if (!input) return
                let randomValue

                switch (index) {
                    case 0: // speed
                        randomValue = Math.floor(Math.random() * 10) + 4 // 4-13
                        break
                    case 1: // hue
                        randomValue = Math.floor(Math.random() * 16)
                        break
                    case 2: // saturation
                        randomValue = Math.floor(Math.random() * 5) + 3 // 3-7
                        break
                    case 3: // lightness
                        randomValue = Math.floor(Math.random() * 3) + 11 // 11-13
                        break
                }

                input.value = randomValue
                input.dataset.hexValue = randomValue.toString(16)
            })

            await updateState()
        }

        // Initialize UI
        if (!shaders?.length) {
            console.error('No shaders available')
        }

        $id('shaders').append(
            ...Object.values(
                shaders.reduce((acc, shader) => {
                    acc[shader[0]] = [...(acc[shader[0]] || []), shader]
                    return acc
                }, {})
            ).map(variations =>
                mkEl('div', { className: 'shader-type' },
                    variations.map(createShaderOption)))
        )

        $id('options').append(
            ...['speed', 'hue', 'saturation', 'lightness'].map(id =>
                createRangeInput({ id, label: id }))
        )

        // Initialize
        const init = withLoader(async () => {
            if (loadSeedFromUrl()) {
                await updateState()
            } else {
                randomizeOptions()
            }
        })

        // Create action buttons
        const createActionButton = (svg, onClick) => mkEl('button', {
            innerHTML: svg,
            onclick: onClick
        })

        const randomizeBtn = createActionButton(
            `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 24 24"><path fill="currentColor" d="M20.536 20.536C22 19.07 22 16.714 22 12s0-7.071-1.465-8.536C19.072 2 16.714 2 12 2S4.929 2 3.464 3.464C2 4.93 2 7.286 2 12s0 7.071 1.464 8.535C4.93 22 7.286 22 12 22s7.071 0 8.535-1.465" opacity="0.5"/><path fill="currentColor" d="M7 10.75a.75.75 0 0 1-.493-1.315l3.437-3a.75.75 0 0 1 .987 1.13L9 9.25h8a.75.75 0 0 1 0 1.5zm6.07 5.685a.75.75 0 0 0 .986 1.13l3.437-3A.75.75 0 0 0 17 13.25H7a.75.75 0 0 0 0 1.5h8z"/></svg>`,
            randomizeOptions
        )

        const copyBtn = createActionButton(
            `<svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 24 24"><path fill="currentColor" d="M3.464 20.536C4.93 22 7.286 22 12 22s7.071 0 8.535-1.465C22 19.072 22 16.714 22 12s0-7.071-1.465-8.536C19.072 2 16.714 2 12 2S4.929 2 3.464 3.464C2 4.93 2 7.286 2 12s0 7.071 1.464 8.535" opacity="0.5"/><path fill="currentColor" d="M9.5 8.75A3.25 3.25 0 1 0 12.75 12a.75.75 0 0 1 1.5 0A4.75 4.75 0 1 1 9.5 7.25a.75.75 0 0 1 0 1.5"/><path fill="currentColor" d="M17.75 12a3.25 3.25 0 0 1-3.25 3.25a.75.75 0 0 0 0 1.5A4.75 4.75 0 1 0 9.75 12a.75.75 0 0 0 1.5 0a3.25 3.25 0 0 1 6.5 0"/></svg>`,
            async () => {
                window.location.hash = state.get().seed
                if (await copyToClipboard(window.location.href)) {
                    showToast('URL copied to clipboard')
                }
            }
        )

        const buttonContainer = mkEl('div', { id: 'actions' }, [randomizeBtn, copyBtn])
        document.body.appendChild(buttonContainer)

        // Create toggle button
        const toggleSvg = [
            `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="currentColor" d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2s7.071 0 8.535 1.464C22 4.93 22 7.286 22 12s0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12" opacity="0.5"/><path fill="currentColor" d="M5.25 13.994a.75.75 0 0 1 .756-.744c.851.008 1.577.034 2.18.152c.623.122 1.166.352 1.612.798s.676.989.798 1.612c.118.603.144 1.329.151 2.18a.75.75 0 0 1-1.5.012c-.007-.856-.035-1.454-.123-1.903c-.084-.43-.212-.666-.387-.84c-.174-.175-.411-.303-.84-.387c-.45-.088-1.047-.116-1.903-.124a.75.75 0 0 1-.744-.756m4.754-8.743a.75.75 0 0 1 .743.756c-.007.851-.033 1.577-.151 2.18c-.122.623-.352 1.166-.798 1.612s-.99.676-1.613.798c-.602.118-1.328.144-2.179.151a.75.75 0 1 1-.012-1.5c.856-.007 1.453-.035 1.903-.123c.429-.084.666-.212.84-.387c.175-.174.303-.411.387-.84c.088-.45.116-1.048.123-1.903a.75.75 0 0 1 .757-.744m3.99 0a.75.75 0 0 1 .756.744c.007.855.035 1.453.123 1.903c.084.429.213.666.387.84c.174.175.411.303.84.387c.45.088 1.048.116 1.904.123a.75.75 0 0 1-.013 1.5c-.85-.007-1.577-.033-2.18-.151c-.623-.122-1.166-.352-1.612-.798s-.675-.99-.798-1.613c-.118-.602-.144-1.328-.151-2.179a.75.75 0 0 1 .743-.756m4.754 8.743a.75.75 0 0 1-.743.756c-.856.008-1.454.036-1.904.124c-.429.084-.666.212-.84.386c-.175.175-.303.412-.387.84c-.088.45-.116 1.048-.124 1.904a.75.75 0 1 1-1.5-.013c.007-.85.033-1.576.151-2.179c.123-.623.352-1.166.798-1.612s.99-.676 1.613-.798c.602-.118 1.328-.144 2.179-.152a.75.75 0 0 1 .756.744"/></svg>`,
            `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="currentColor" d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2s7.071 0 8.535 1.464C22 4.93 22 7.286 22 12s0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12" opacity="0.5"/><path fill="currentColor" d="M10.004 6.75a.75.75 0 0 0-.013-1.5c-.85.007-1.577.034-2.179.152c-.623.122-1.167.351-1.613.797s-.675.99-.797 1.613c-.118.602-.145 1.328-.152 2.179a.75.75 0 0 0 1.5.013c.007-.856.035-1.454.124-1.904c.084-.428.212-.666.386-.84s.412-.302.84-.386c.45-.088 1.048-.117 1.904-.124m4.003-1.5a.75.75 0 1 0-.013 1.5c.856.007 1.454.035 1.903.124c.429.084.666.212.84.386c.175.174.303.412.387.84c.088.45.116 1.048.124 1.904a.75.75 0 0 0 1.5-.013c-.008-.85-.034-1.577-.152-2.179c-.122-.623-.352-1.167-.798-1.613s-.99-.675-1.612-.797c-.603-.118-1.329-.145-2.18-.152M6.75 13.994a.75.75 0 0 0-1.5.013c.007.85.034 1.577.152 2.179c.122.623.351 1.167.797 1.613s.99.675 1.613.797c.602.119 1.328.145 2.179.152a.75.75 0 0 0 .013-1.5c-.856-.007-1.454-.036-1.904-.123c-.428-.084-.666-.213-.84-.387s-.302-.412-.386-.84c-.088-.45-.117-1.048-.124-1.904m11.998.013a.75.75 0 1 0-1.5-.013c-.008.856-.036 1.454-.124 1.904c-.084.428-.212.666-.386.84s-.412.303-.84.387c-.45.087-1.048.116-1.904.123a.75.75 0 1 0 .013 1.5c.85-.007 1.576-.034 2.179-.152c.623-.122 1.166-.351 1.612-.797s.676-.99.798-1.613c.118-.602.144-1.328.151-2.179"/></svg>`,
        ]

        const mainToggle = mkEl('button', {
            id: 'toggle',
            innerHTML: toggleSvg[Number(state.get().isVisible)],
            onclick: () => {
                const newState = state.update({ isVisible: !state.get().isVisible })
                const main = $('main')
                const usage = $('.usage')
                main.classList.toggle('hidden')
                usage.classList.toggle('hidden')
                mainToggle.innerHTML = toggleSvg[Number(newState.isVisible)]
            }
        })

        document.body.appendChild(mainToggle)

        // Add copy functionality to seed and usage
        const addCopyHandler = (el, getText) => {
            el.style.cursor = 'pointer'
            el.onclick = async () => {
                const text = getText()
                if (text && await copyToClipboard(text)) {
                    showToast('Copied to clipboard')
                }
            }
        }

        addCopyHandler($id('seed'), () => $id('seed').textContent)
        addCopyHandler($('.usage'), () => $('.usage code')?.textContent)

        init()
    </script>
</body>

</html>